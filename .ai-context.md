# AI Context - Rematch Balancer

> This file helps AI assistants understand the project quickly without needing full chat history.

## Project Overview

**Rematch Balancer** is a player rating system for the Discord community "ASLI CIKMAZI". 
Users sign in with Discord, rate each other (1-10), and view a ranked scoreboard.

## Current Status (MVP)

✅ **Implemented:**
- Discord OAuth authentication
- Rate other players (1-10 slider)
- View scoreboard with rankings
- Custom player names (profile page)
- Real-time vote saving with debounce

❌ **Not Implemented (Future):**
- Team balancing algorithm
- Vote history/audit log
- Real-time subscriptions
- Discord guild gating

## Tech Stack

- **Frontend**: Next.js 14 (App Router), TypeScript, Tailwind CSS
- **Backend**: Supabase (PostgreSQL + Auth + RLS)
- **Deploy**: Vercel (auto-deploy from main)
- **Auth**: Discord OAuth via Supabase

## Key Files

| File | Purpose |
|------|---------|
| `app/layout.tsx` | Root layout with AuthGate wrapper |
| `app/rate/page.tsx` | Rate players with sliders |
| `app/scoreboard/page.tsx` | View rankings |
| `app/profile/page.tsx` | Edit custom display name |
| `components/AuthGate.tsx` | Auth wrapper + nav bar |
| `lib/supabaseClient.ts` | Supabase client + types |
| `supabase/migrations/` | Database migrations (numbered) |

## Database Schema

```sql
-- Core tables
players (user_id, discord_id, display_name, custom_name, avatar_url)
votes (voter_id, target_id, score, updated_at)

-- View
player_ratings (player_id, display_name, avatar_url, avg_score, voter_count)
```

## Development Workflow

1. **Make changes** to code/database
2. **Create migration** if DB changed (`supabase/migrations/00X_name.sql`)
3. **Update types** in `lib/supabaseClient.ts` if needed
4. **Test locally** with `npm run dev`
5. **Commit & push** to main → auto-deploys to Vercel

## Common Tasks

### Adding a new database field
1. Create `supabase/migrations/00X_add_field.sql`
2. Add field to type in `lib/supabaseClient.ts`
3. Update `player_ratings` view if needed
4. Run migration in Supabase SQL Editor
5. Update README in migrations folder

### Adding a new page
1. Create `app/new-page/page.tsx`
2. Add link in `components/AuthGate.tsx` nav
3. Add card in `app/page.tsx` home
4. Test auth requirement works

### Adding a UI component
1. Create in `components/ui/component-name.tsx`
2. Follow shadcn/ui pattern (forwardRef, cn helper)
3. Export and use where needed

## Design Patterns

- **No global state**: React state + Supabase is enough
- **Client components**: Only when using hooks/events
- **RLS security**: All DB access controlled by Supabase policies
- **Type safety**: TypeScript strict mode, types for all DB tables
- **Idempotent migrations**: Use `IF EXISTS` / `IF NOT EXISTS`

## Important Rules

1. **Never modify old migrations** - always create new ones
2. **Use RLS policies** - never bypass security
3. **Custom name > Discord name** - always check `custom_name` first
4. **Debounce auto-saves** - don't spam the database
5. **Handle errors gracefully** - log to console, show user feedback

## Environment Variables

```bash
NEXT_PUBLIC_SUPABASE_URL=https://xxx.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=xxx
```

## Deployment Checklist

After deploying:
- [ ] Update Discord OAuth redirect URLs
- [ ] Update Supabase Auth site URLs
- [ ] Run any new migrations in prod
- [ ] Test auth flow on production
- [ ] Verify all pages load

## User Flows

**Sign In:**
User clicks button → Discord OAuth → Supabase → ensurePlayer() → Home

**Rating:**
Go to /rate → See all players except self → Slide to rate (1-10) → Auto-saves (debounced)

**Scoreboard:**
Go to /scoreboard → View sorted by avg_score DESC → See medals & vote counts

**Profile:**
Go to /profile → Set custom name → Saves to DB → Displays everywhere

## Code Style

- Tailwind for all styling
- TypeScript strict mode
- Functional components with hooks
- Explicit types, avoid `any`
- Comments for complex logic
- Descriptive variable names

## Questions to Ask User

When adding new features, consider:
- Does this need a database migration?
- Does this affect existing user data?
- Should this be behind authentication?
- How should errors be handled?
- Where should this link from?

## Useful Commands

```bash
npm run dev          # Start dev server
npm run build        # Build for production
npm run lint         # Check for issues
git push origin main # Deploy to production
```

## References

- [Full Architecture](./ARCHITECTURE.md)
- [Setup Guide](./SETUP.md)
- [Development Guide](./DEVELOPMENT.md)
- [Migration Guide](./supabase/migrations/README.md)

